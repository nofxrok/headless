<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>Reactor System</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="schema.DC" href="http://purl.org/dc/terms/">
      <meta name="DC.Type" content="concept">
      
      <meta name="DC.Title" content="Reactor System">
      
      <meta name="DC.Relation" scheme="URI" content="../../../enterprise/user-guide.html">
      
      <meta name="DC.Format" content="XHTML">
      
      <meta name="DC.Identifier" content="reactor-system">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/bootstrap.min.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/fonts.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/prism.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/lightbox.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/webhelp.css">
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery-1.11.0.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery-ui-1.9.1.custom.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery.slimscroll.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery.tocify.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/prism.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/lightbox.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/webhelp.js"></script>
      </head>
   <body>
      <div id="wrapper">
         <div id="sidebar-wrapper"><a class="ss-logo" href="/help/home.html"></a><div id="search-form" class="inner-addon left-addon"><i class="glyphicon glyphicon-search"></i><input type="text" class="form-control"></div>
            <div id="guide-links">
               <div class="well">
                  <ul class="nav nav-pills nav-stacked">
                     <li><a href="/help/gs/index.html"><span class="glyphicon glyphicon glyphicon-th-list"></span> Get Started</a></li>
                     <li><a href="/help/home.html"><span class="glyphicon glyphicon-home"></span>  Home</a></li>
                     <li><a href="/help/enterprise/user-guide.html"><span class="glyphicon glyphicon-user"></span> User Guide</a></li>
                  </ul>
               </div>
               <p id="guide-title">Enterprise Help</p>
            </div>
            <div class="sidebar-nav">
               <ul id="gen-links">
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/use-cases.html">Use Cases</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/continuous-deployment.html">Continuous Deployment</a></li>
                        <li class=" no-child "><a href="../../../enterprise/app-stacks.html">Application Stacks</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../enterprise/cloud.html">Cloud Management</a><ul>
                              <li class=" no-child "><a href="../../../enterprise/orchestrate.html">Orchestration</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../enterprise/security-bp.html">Security Best Practices</a></li>
                        <li class=" no-child "><a href="../../../enterprise/components.html">SaltStack Components</a></li>
                     </ul>
                  </li>
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/deployment.html">Deployment</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/t_ops_prepare.html">Preparing the SaltStack Ops System</a></li>
                        <li class=" no-child "><a href="../../../enterprise/t_master_prepare.html">Preparing Masters for SaltStack Ops Integration</a></li>
                        <li class=" no-child "><a href="../../../enterprise/requirements.html">System Requirements</a></li>
                        <li class=" no-child "><a href="../../../enterprise/faq.html">Frequently Asked Questions</a></li>
                     </ul>
                  </li>
                  <li class=" no-child "><a href="../../../enterprise/masters.html">View Masters</a></li>
                  <li class=" no-child "><a href="../../../enterprise/minions.html">View Minions</a></li>
                  <li class=" no-child "><a href="../../../enterprise/jobs.html">Jobs</a></li>
                  <li class=" no-child "><a href="../../../enterprise/targets.html">Targets</a></li>
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/management.html">Admin Management</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/cfg-masters.html">Manage Masters</a></li>
                        <li class=" no-child "><a href="../../../enterprise/jobs-all.html">Manage Jobs</a></li>
                        <li class=" no-child "><a href="../../../enterprise/cfg-users.html">User Accounts</a></li>
                     </ul>
                  </li>
                  <li class=" no-child "><a href="../../../enterprise/web-console-overview.html">Console Overview</a></li>
                  <li class=" no-child "><a href="../../../enterprise/reports.html">View Reports</a></li>
                  <li class=" no-child "><a href="../../../enterprise/architecture.html">Architecture Reference</a></li>
                  <li class=" no-child "><a href="../../../enterprise/glossary.html">Glossary</a></li>
                  <li class=" collapsible  active"><a href="../../../enterprise/user-guide.html">SaltStack User Guide</a><ul>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/installation/index.html">Installation</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/installation/debian.html">Debian Installation</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/freebsd.html">FreeBSD</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/gentoo.html">Gentoo</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/solaris.html">Solaris</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/ubuntu.html">Ubuntu Installation</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/windows.html">Windows</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/tutorials/index.html">Tutorials</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/standalone_minion.html">Standalone Minion</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/cron.html">Using cron with Salt</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/states_pt1.html">States tutorial, part 1 - Basic Usage</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/states_pt2.html">States tutorial, part 2 - More Complex States, Requisites</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/states_pt4.html">States tutorial, part 4</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/minionfs.html">MinionFS Backend Walkthrough</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/multimaster_pki.html">Multi-Master-PKI Tutorial With Failover</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/writing_tests.html">Writing Salt Tests</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/halite.html">Installing and Configuring Halite</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/targeting/index.html">Targeting Minions</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/targeting/globbing.html">Matching the minion id</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/grains.html">Grains</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/ipcidr.html">Subnet/IP Address Matching</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/compound.html">Compound matchers</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/nodegroups.html">Node groups</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/batch.html">Batch Size</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/range.html">SECO Range</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/pillar/index.html">Storing Static Data in the Pillar</a></li>
                        <li class=" no-child  active">
                           <div id="toc"></div>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/eauth/index.html">External Authentication System</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/eauth/access_control.html">Access Control System</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/event/index.html">Salt Event System</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/event/master_events.html">Salt Master Events</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/topology/syndic.html">Salt Syndic</a></li>
                        <li class=" no-child "><a href="../../../user/topics/topology/proxyminion/index.html">Proxy Minion</a></li>
                        <li class=" no-child "><a href="../../../user/topics/windows/windows-specific-behavior.html">Windows-specific Behaviour</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/cloud/index.html">Salt Cloud</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/cloud/basic.html">Salt Cloud basic usage</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/profiles.html">VM Profiles</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/map.html">Cloud Map File</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/action.html">Cloud Actions</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/function.html">Cloud Functions</a></li>
                              <li class=" collapsible  collapsed"><a href="../../../user/topics/cloud/provider-specifics.html">Cloud Provider Specifics</a><ul>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/parallels.html">Getting Started With Parallels</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/proxmox.html">Getting Started With Proxmox</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/lxc.html">Getting Started With LXC</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/hpcloud.html">Getting Started With HP Cloud</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/vexxhost.html">Getting Started with VEXXHOST</a></li>
                                 </ul>
                              </li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/deploy.html">OS Support for Cloud VMs</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/features.html">Feature Matrix</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/windows.html">Spinning up Windows Minions</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/netapi/index.html">netapi modules</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/netapi/writing.html">Writing netapi modules</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/virt/index.html">Salt Virt</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/virt/disk.html">Virtual Machine Disk Profiles</a></li>
                              <li class=" no-child "><a href="../../../user/topics/virt/nic.html">Virtual Machine Network Profiles</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/yaml/index.html">Understanding YAML</a></li>
                        <li class=" no-child "><a href="../../../user/topics/master_tops/index.html">Master Tops System</a></li>
                        <li class=" no-child "><a href="../../../user/topics/best_practices.html">Salt Best Practices</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/troubleshooting/index.html">Troubleshooting</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/troubleshooting/minion.html">Troubleshooting the Salt Minion</a></li>
                           </ul>
                        </li>
                     </ul>
                  </li>
               </ul>
            </div>
         </div>
         <div id="page-content-wrapper">
            <div class="container-fluid">
               <div class="row">
                  <div class="col-lg-12">
                     <div class="page concept  - topic-topic concept-concept " id="reactor-system">
                        
                        <h1 class="title topictitle1">Reactor System</h1>
                        <div class="body conbody">
                           <p class="p">Salt version 0.11.0 introduced the reactor system. The premise behind the
                              reactor system is that with Salt's events and the ability to execute commands,
                              a logic engine could be put in place to allow events to trigger actions, or
                              more accurately, reactions.
                           </p>
                           
                           <p class="p">This system binds sls files to event tags on the master. These sls files then
                              define reactions. This means that the reactor system has two parts. First, the
                              reactor option needs to be set in the master configuration file.  The reactor
                              option allows for event tags to be associated with sls reaction files. Second,
                              these reaction files use highdata (like the state system) to define reactions
                              to be executed.
                           </p>
                           
                           <div class="section" id="reactor-system__event-system">
                              <h2 class="title sectiontitle">Event System</h2>
                              <p class="p">A basic understanding of the event system is required to understand reactors.
                                 The event system is a local ZeroMQ PUB interface which fires salt events. This
                                 event bus is an open system used for sending information notifying Salt and
                                 other systems about operations.
                              </p>
                              
                              <p class="p">The event system fires events with a very specific criteria. Every event has a
                                 <strong class="ph b">tag</strong>. Event tags allow for fast top level filtering of events. In
                                 addition to the tag, each event has a data structure. This data structure is a
                                 dict, which contains information about the event.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="reactor-system__mapping-events-to-reactor-sls-files">
                              <h2 class="title sectiontitle">Mapping Events to Reactor SLS Files</h2>
                              <p class="p">Reactor SLS files and event tags are associated in the master config file.
                                 By default this is /etc/salt/master, or /etc/salt/master.d/reactor.conf.
                              </p>
                              
                              <p class="p"><span class="keyword inline">New in version 2014.7.0: </span>Added Reactor support for <tt class="ph tt">salt://</tt> file paths.
                              </p>
                              
                              <p class="p">In the master config section 'reactor:' is a list of event tags to be matched
                                 and each event tag has a list of reactor SLS files to be run.
                              </p>
                              <pre class="pre codeblock language-yaml">reactor:                            # Master config section "reactor"

  - 'salt/minion/*/start':          # Match tag "salt/minion/*/start"
    - /srv/reactor/start.sls        # Things to do when a minion starts
    - /srv/reactor/monitor.sls      # Other things to do

  - 'salt/cloud/*/destroyed':       # Globs can be used to matching tags
    - /srv/reactor/destroy/*.sls    # Globs can be used to match file names

  - 'myco/custom/event/tag':        # React to custom event tags
    - salt://reactor/mycustom.sls   # Put reactor files under file_roots</pre>
                              <p class="p">Reactor sls files are similar to state and pillar sls files.  They are
                                 by default yaml + Jinja templates and are passed familiar context variables.
                              </p>
                              
                              <p class="p">They differ because of the addition of the <tt class="ph tt">tag</tt> and <tt class="ph tt">data</tt> variables.
                              </p>
                              
                              <ul class="ul">
                                 <li class="li">
                                    <p class="p">The <tt class="ph tt">tag</tt> variable is just the tag in the fired event.
                                    </p>
                                    
                                 </li>
                                 
                                 <li class="li">
                                    <p class="p">The <tt class="ph tt">data</tt> variable is the event's data dict.
                                    </p>
                                    
                                 </li>
                                 
                              </ul>
                              
                              <p class="p">Here is a simple reactor sls:</p>
                              <pre class="pre codeblock language-yaml">{% if data['id'] == 'mysql1' %}
highstate_run:
  local.state.highstate:
    - tgt: mysql1
{% endif %}</pre>
                              <p class="p">This simple reactor file uses Jinja to further refine the reaction to be made.
                                 If the <tt class="ph tt">id</tt> in the event data is <tt class="ph tt">mysql1</tt> (in other words, if the name of
                                 the minion is <tt class="ph tt">mysql1</tt>) then the following reaction is defined.  The same
                                 data structure and compiler used for the state system is used for the reactor
                                 system. The only difference is that the data is matched up to the salt command
                                 API and the runner system.  In this example, a command is published to the
                                 <tt class="ph tt">mysql1</tt> minion with a function of <tt class="ph tt">state.highstate</tt>. Similarly, a runner
                                 can be called:
                              </p>
                              <pre class="pre codeblock language-yaml">{% if data['data']['overstate'] == 'refresh' %}
overstate_run:
  runner.state.over
{% endif %}</pre>
                              <p class="p">This example will execute the state.overstate runner and initiate an overstate
                                 execution.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="reactor-system__fire-an-event">
                              <h2 class="title sectiontitle">Fire an event</h2>
                              <p class="p">To fire an event from a minion call <tt class="ph tt">event.fire_master</tt></p>
                              <pre class="pre codeblock language-bash">salt-call event.fire_master '{"overstate": "refresh"}' 'foo'</pre>
                              <p class="p">After this is called, any reactor sls files matching event tag <tt class="ph tt">foo</tt> will
                                 execute with <tt class="ph tt">{{ data['data']['overstate'] }}</tt> equal to <tt class="ph tt">'refresh'</tt>.
                              </p>
                              
                              <p class="p">See <a class="xref" href="unresolvable-reference.html#module-salt.modules.event__module-salt.modules.event">salt.modules.event</a> for more information.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="reactor-system__knowing-what-event-is-being-fired">
                              <h2 class="title sectiontitle">Knowing what event is being fired</h2>
                              <p class="p">Knowing exactly which event is being fired and what data it has for use in the
                                 sls files can be challenging. The easiest way to see exactly what's going on is
                                 to use the <strong class="ph b">eventlisten.py</strong> script. This script is not part of packages
                                 but is part of the source.
                              </p>
                              
                              <p class="p">If the master process is using the default socket, no additional options will be
                                 required. Otherwise, you will need to specify the socket location.
                              </p>
                              
                              <p class="p">Example usage:</p>
                              <pre class="pre codeblock language-bash">wget https://raw.githubusercontent.com/saltstack/salt/develop/tests/eventlisten.py
python eventlisten.py

# OR
python eventlisten.py --sock-dir /path/to/var/run/salt</pre>
                              <p class="p">Example output:</p>
                              <pre class="pre codeblock language-text">Event fired at Fri Dec 20 10:43:00 2013
*************************
Tag: salt/auth
Data:
{'_stamp': '2013-12-20_10:47:54.584699',
 'act': 'accept',
 'id': 'fuzzer.domain.tld',
 'pub': '-----BEGIN PUBLIC KEY-----\nMIICIDANBgk+TRIMMED+EMZ8CAQE=\n-----END PUBLIC KEY-----\n',
 'result': True}

Event fired at Fri Dec 20 10:43:01 2013
*************************
Tag: salt/minion/fuzzer.domain.tld/start
Data:
{'_stamp': '2013-12-20_10:43:01.638387',
 'cmd': '_minion_event',
 'data': 'Minion fuzzer.domain.tld started at Fri Dec 20 10:43:01 2013',
 'id': 'fuzzer.domain.tld',
 'pretag': None,
 'tag': 'salt/minion/fuzzer.domain.tld/start'}</pre>
                              </div>
                           
                           <div class="section" id="reactor-system__debugging-the-reactor">
                              <h2 class="title sectiontitle">Debugging the Reactor</h2>
                              <p class="p">The best window into the Reactor is to run the master in the foreground with
                                 debug logging enabled. The output will include when the master sees the event,
                                 what the master does in response to that event, and it will also include the
                                 rendered SLS file (or any errors generated while rendering the SLS file).
                              </p>
                              
                              <ol class="ol">
                                 <li class="li">
                                    <p class="p">Stop the master.</p>
                                    
                                 </li>
                                 
                                 <li class="li">
                                    <p class="p">Start the master manually:</p>
                                    <pre class="pre codeblock language-bash">salt-master -l debug</pre>
                                    </li>
                                 
                              </ol>
                              
                           </div>
                           
                           <div class="section" id="reactor-system__understanding-the-structure-of-reactor-formulas">
                              <h2 class="title sectiontitle">Understanding the Structure of Reactor Formulas</h2>
                              <p class="p">While the reactor system uses the same data structure as the state system, this
                                 data does not translate the same way to function calls.
                              </p>
                              
                              <p class="p"><span class="keyword inline">Changed in version 2014.7.0: </span>The <tt class="ph tt">cmd</tt> prefix was renamed to <tt class="ph tt">local</tt> for consistency with other
                                 parts of Salt. A backward-compatible alias was added for <tt class="ph tt">cmd</tt>.
                              </p>
                              
                              <p class="p">In state files the minion generates the data structure locally and uses that to
                                 call local state functions. In the reactor system the master generates a data
                                 structure that is used to call methods on one of Salt's client interfaces
                                 described in <a class="xref" href="unresolvable-reference.html#python-client-api__client-apis">the Python API documentation</a>.
                              </p>
                              
                              <ul class="ul">
                                 <li class="li">
                                    <p class="p"><a class="xref" href="unresolvable-reference.html#python-client-api__salt.client.LocalClient">LocalClient</a> is used to call Execution modules
                                       remotely on minions. (The salt CLI program uses this also.)
                                    </p>
                                    
                                 </li>
                                 
                                 <li class="li">
                                    <p class="p"><a class="xref" href="unresolvable-reference.html#python-client-api__salt.runner.RunnerClient">RunnerClient</a> calls Runner modules locally on the
                                       master.
                                    </p>
                                    
                                 </li>
                                 
                                 <li class="li">
                                    <p class="p"><a class="xref" href="unresolvable-reference.html#python-client-api__salt.wheel.WheelClient">WheelClient</a> calls Wheel modules locally on the
                                       master.
                                    </p>
                                    
                                 </li>
                                 
                              </ul>
                              
                              <p class="p">The <strong class="ph b">state declaration</strong> field takes a reference to the function to call
                                 in each interface. So to trigger a salt-run call the <strong class="ph b">state
                                    declaration</strong> field will start with <strong class="ph b">runner</strong>, followed by the runner
                                 function to call. This means that a call to what would be on the command line
                                 <strong class="ph b">salt-run manage.up</strong> will be <strong class="ph b">runner.manage.up</strong>. An example of
                                 this in a reactor formula would look like this:
                              </p>
                              <pre class="pre codeblock language-yaml">manage_up:
  runner.manage.up</pre>
                              <p class="p">If the runner takes arguments then they can be specified as well:</p>
                              <pre class="pre codeblock language-yaml">overstate_dev_env:
  runner.state.over:
    - env: dev</pre>
                              <p class="p">Executing remote commands maps to the <strong class="ph b">LocalClient</strong> interface which is
                                 used by the <strong class="ph b">salt</strong> command. This interface more specifically maps to
                                 the <strong class="ph b">cmd_async</strong> method inside of the <strong class="ph b">LocalClient</strong> class. This
                                 means that the arguments passed are being passed to the <strong class="ph b">cmd_async</strong>
                                 method, not the remote method. A field starts with <strong class="ph b">local</strong> to use the
                                 <strong class="ph b">LocalClient</strong> subsystem. The result is, to execute a remote command,
                                 a reactor formula would look like this:
                              </p>
                              <pre class="pre codeblock language-yaml">clean_tmp:
  local.cmd.run:
    - tgt: '*'
    - arg:
      - rm -rf /tmp/*</pre>
                              <p class="p">The <tt class="ph tt">arg</tt> option takes a list of arguments as they would be presented on the
                                 command line, so the above declaration is the same as running this salt
                                 command:
                              </p>
                              <pre class="pre codeblock language-bash">salt '*' cmd.run 'rm -rf /tmp/*'</pre>
                              <p class="p">Use the <tt class="ph tt">expr_form</tt> argument to specify a matcher:
                              </p>
                              <pre class="pre codeblock language-yaml">clean_tmp:
  local.cmd.run:
    - tgt: 'os:Ubuntu'
    - expr_form: grain
    - arg:
      - rm -rf /tmp/*


clean_tmp:
  local.cmd.run:
    - tgt: 'G@roles:hbase_master'
    - expr_form: compound
    - arg:
      - rm -rf /tmp/*</pre>
                              <p class="p">An interesting trick to pass data from the Reactor script to
                                 <tt class="ph tt">state.highstate</tt> or <tt class="ph tt">state.sls</tt> is to pass it as inline Pillar data since
                                 both functions take a keyword argument named <tt class="ph tt">pillar</tt>.
                              </p>
                              
                              <p class="p">The following example uses Salt's Reactor to listen for the event that is fired
                                 when the key for a new minion is accepted on the master using <tt class="ph tt">salt-key</tt>.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/etc/salt/master.d/reactor.conf</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">reactor:
  - 'salt/key':
    - /srv/salt/haproxy/react_new_minion.sls</pre>
                              <p class="p">The Reactor then fires a <tt class="ph tt">state.sls</tt> command targeted to the HAProxy servers
                                 and passes the ID of the new minion from the event to the state file via inline
                                 Pillar.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/srv/salt/haproxy/react_new_minion.sls</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">{% if data['act'] == 'accept' and data['id'].startswith('web') %}
add_new_minion_to_pool:
  local.state.sls:
    - tgt: 'haproxy*'
    - arg:
      - haproxy.refresh_pool
    - kwarg:
        pillar:
          new_minion: {{ data['id'] }}
{% endif %}</pre>
                              <p class="p">The above command is equivalent to the following command at the CLI:</p>
                              <pre class="pre codeblock language-bash">salt 'haproxy*' state.sls haproxy.refresh_pool 'pillar={new_minion: minionid}'</pre>
                              <p class="p">Finally, that data is available in the state file using the normal Pillar
                                 lookup syntax. The following example is grabbing web server names and IP
                                 addresses from <a class="xref" href="unresolvable-reference.html#the-salt-mine__salt-mine">Salt Mine</a>. If this state is invoked from the
                                 Reactor then the custom Pillar value from above will be available and the new
                                 minion will be added to the pool but with the <tt class="ph tt">disabled</tt> flag so that HAProxy
                                 won't yet direct traffic to it.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/srv/salt/haproxy/refresh_pool.sls</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">{% set new_minion = salt['pillar.get']('new_minion') %}

listen web *:80
    balance source
    {% for server,ip in salt['mine.get']('web*', 'network.interfaces', ['eth0']).items() %}
    {% if server == new_minion %}
    server {{ server }} {{ ip }}:80 disabled
    {% else %}
    server {{ server }} {{ ip }}:80 check
    {% endif %}
    {% endfor %}</pre>
                              </div>
                           
                           <div class="section" id="reactor-system__a-complete-example">
                              <h2 class="title sectiontitle">A Complete Example</h2>
                              <p class="p">In this example, we're going to assume that we have a group of servers that
                                 will come online at random and need to have keys automatically accepted. We'll
                                 also add that we don't want all servers being automatically accepted. For this
                                 example, we'll assume that all hosts that have an id that starts with 'ink'
                                 will be automatically accepted and have state.highstate executed. On top of
                                 this, we're going to add that a host coming up that was replaced (meaning a new
                                 key) will also be accepted.
                              </p>
                              
                              <p class="p">Our master configuration will be rather simple. All minions that attempte to
                                 authenticate will match the <strong class="ph b">tag</strong> of <strong class="ph b">salt/auth</strong>. When it comes
                                 to the minion key being accepted, we get a more refined <strong class="ph b">tag</strong> that
                                 includes the minion id, which we can use for matching.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/etc/salt/master.d/reactor.conf</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">reactor:
  - 'salt/auth':
    - /srv/reactor/auth-pending.sls
  - 'salt/minion/ink*/start':
    - /srv/reactor/auth-complete.sls</pre>
                              <p class="p">In this sls file, we say that if the key was rejected we will delete the key on
                                 the master and then also tell the master to ssh in to the minion and tell it to
                                 restart the minion, since a minion process will die if the key is rejected.
                              </p>
                              
                              <p class="p">We also say that if the key is pending and the id starts with ink we will
                                 accept the key. A minion that is waiting on a pending key will retry
                                 authentication every ten seconds by default.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/srv/reactor/auth-pending.sls</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">{# Ink server faild to authenticate -- remove accepted key #}
{% if not data['result'] and data['id'].startswith('ink') %}
minion_remove:
  wheel.key.delete:
    - match: {{ data['id'] }}
minion_rejoin:
  local.cmd.run:
    - tgt: salt-master.domain.tld
    - arg:
      - ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no "{{ data['id'] }}" 'sleep 10 &amp;&amp; /etc/init.d/salt-minion restart'
{% endif %}

{# Ink server is sending new key -- accept this key #}
{% if 'act' in data and data['act'] == 'pend' and data['id'].startswith('ink') %}
minion_add:
  wheel.key.accept:
    - match: {{ data['id'] }}
{% endif %}</pre>
                              <p class="p">No if statements are needed here because we already limited this action to just
                                 Ink servers in the master configuration.
                              </p>
                              
                              <p class="p"><tt class="ph tt">/srv/reactor/auth-complete.sls</tt>:
                              </p>
                              <pre class="pre codeblock language-yaml">{# When an Ink server connects, run state.highstate. #}
highstate_run:
  local.state.highstate:
    - tgt: {{ data['id'] }}
    - ret: smtp_return</pre>
                              <p class="p">The above will also return the highstate result data using the <a class="xref title_reference" href="index.html">smtp_return</a>
                                 returner. The returner needs to be configured on the minion for this to
                                 work. See <a class="xref" href="unresolvable-reference.html#module-salt.returners.smtp_return__module-salt.returners.smtp_return">salt.returners.smtp_return</a> documentation for
                                 that.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="reactor-system__syncing-custom-types-on-minion-start">
                              <h2 class="title sectiontitle">Syncing Custom Types on Minion Start</h2>
                              <p class="p">Salt will sync all custom types (by running a <a class="xref" href="unresolvable-reference.html#module-salt.modules.saltutil__salt.modules.saltutil.sync_all">saltutil.sync_all</a>) on every highstate. However, there is a
                                 chicken-and-egg issue where, on the initial highstate, a minion will not yet
                                 have these custom types synced when the top file is first compiled. This can be
                                 worked around with a simple reactor which watches for <tt class="ph tt">minion_start</tt> events,
                                 which each minion fires when it first starts up and connects to the master.
                              </p>
                              
                              <p class="p">On the master, create <strong class="ph b">/srv/reactor/sync_grains.sls</strong> with the following
                                 contents:
                              </p>
                              <pre class="pre codeblock language-yaml">sync_grains:
  local.saltutil.sync_grains:
    - tgt: {{ data['id'] }}</pre>
                              <p class="p">And in the master config file, add the following reactor configuration:</p>
                              <pre class="pre codeblock language-yaml">reactor:
  - 'minion_start':
    - /srv/reactor/sync_grains.sls</pre>
                              <p class="p">This will cause the master to instruct each minion to sync its custom grains
                                 when it starts, making these grains available when the initial highstate is
                                 executed.
                              </p>
                              
                              <p class="p">Other types can be synced by replacing <tt class="ph tt">local.saltutil.sync_grains</tt> with
                                 <tt class="ph tt">local.saltutil.sync_modules</tt>, <tt class="ph tt">local.saltutil.sync_all</tt>, or whatever else
                                 suits the intended use case.
                              </p>
                              
                           </div>
                           
                        </div>
                        
                        <div xmlns:htmlutil="http://dita4publishers.org/functions/htmlutil" class="related-links"></div>
                     </div>
                     <button id="next-button" type="button" class="btn btn-primary">
                        Next <span class="glyphicon glyphicon-chevron-right"></span></button><div class="footer">
                        <p class="text-muted pull-right"><small>Copyright © 2015 SaltStack.</small></p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </body>
</html>