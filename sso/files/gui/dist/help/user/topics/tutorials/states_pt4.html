<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>States tutorial, part 4</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="schema.DC" href="http://purl.org/dc/terms/">
      <meta name="DC.Type" content="concept">
      
      <meta name="DC.Title" content="States tutorial, part 4">
      
      <meta name="DC.Relation" scheme="URI" content="index.html">
      
      <meta name="DC.Format" content="XHTML">
      
      <meta name="DC.Identifier" content="states-tutorial-part-4">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/bootstrap.min.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/fonts.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/prism.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/lightbox.css">
      
      <link rel="stylesheet" type="text/css" media="screen, projection" href="../../../themes/bootstrap/css/webhelp.css">
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery-1.11.0.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery-ui-1.9.1.custom.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery.slimscroll.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/jquery.tocify.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/prism.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/lightbox.min.js"></script>
      <script type="text/javascript" src="../../../themes/bootstrap/js/webhelp.js"></script>
      </head>
   <body>
      <div id="wrapper">
         <div id="sidebar-wrapper"><a class="ss-logo" href="/help/home.html"></a><div id="search-form" class="inner-addon left-addon"><i class="glyphicon glyphicon-search"></i><input type="text" class="form-control"></div>
            <div id="guide-links">
               <div class="well">
                  <ul class="nav nav-pills nav-stacked">
                     <li><a href="/help/gs/index.html"><span class="glyphicon glyphicon glyphicon-th-list"></span> Get Started</a></li>
                     <li><a href="/help/home.html"><span class="glyphicon glyphicon-home"></span>  Home</a></li>
                     <li><a href="/help/enterprise/user-guide.html"><span class="glyphicon glyphicon-user"></span> User Guide</a></li>
                  </ul>
               </div>
               <p id="guide-title">Enterprise Help</p>
            </div>
            <div class="sidebar-nav">
               <ul id="gen-links">
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/use-cases.html">Use Cases</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/continuous-deployment.html">Continuous Deployment</a></li>
                        <li class=" no-child "><a href="../../../enterprise/app-stacks.html">Application Stacks</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../enterprise/cloud.html">Cloud Management</a><ul>
                              <li class=" no-child "><a href="../../../enterprise/orchestrate.html">Orchestration</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../enterprise/security-bp.html">Security Best Practices</a></li>
                        <li class=" no-child "><a href="../../../enterprise/components.html">SaltStack Components</a></li>
                     </ul>
                  </li>
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/deployment.html">Deployment</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/t_ops_prepare.html">Preparing the SaltStack Ops System</a></li>
                        <li class=" no-child "><a href="../../../enterprise/t_master_prepare.html">Preparing Masters for SaltStack Ops Integration</a></li>
                        <li class=" no-child "><a href="../../../enterprise/requirements.html">System Requirements</a></li>
                        <li class=" no-child "><a href="../../../enterprise/faq.html">Frequently Asked Questions</a></li>
                     </ul>
                  </li>
                  <li class=" no-child "><a href="../../../enterprise/masters.html">View Masters</a></li>
                  <li class=" no-child "><a href="../../../enterprise/minions.html">View Minions</a></li>
                  <li class=" no-child "><a href="../../../enterprise/jobs.html">Jobs</a></li>
                  <li class=" no-child "><a href="../../../enterprise/targets.html">Targets</a></li>
                  <li class=" collapsible  collapsed"><a href="../../../enterprise/management.html">Admin Management</a><ul>
                        <li class=" no-child "><a href="../../../enterprise/cfg-masters.html">Manage Masters</a></li>
                        <li class=" no-child "><a href="../../../enterprise/jobs-all.html">Manage Jobs</a></li>
                        <li class=" no-child "><a href="../../../enterprise/cfg-users.html">User Accounts</a></li>
                     </ul>
                  </li>
                  <li class=" no-child "><a href="../../../enterprise/web-console-overview.html">Console Overview</a></li>
                  <li class=" no-child "><a href="../../../enterprise/reports.html">View Reports</a></li>
                  <li class=" no-child "><a href="../../../enterprise/architecture.html">Architecture Reference</a></li>
                  <li class=" no-child "><a href="../../../enterprise/glossary.html">Glossary</a></li>
                  <li class=" collapsible  active"><a href="../../../enterprise/user-guide.html">SaltStack User Guide</a><ul>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/installation/index.html">Installation</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/installation/debian.html">Debian Installation</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/freebsd.html">FreeBSD</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/gentoo.html">Gentoo</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/solaris.html">Solaris</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/ubuntu.html">Ubuntu Installation</a></li>
                              <li class=" no-child "><a href="../../../user/topics/installation/windows.html">Windows</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  active"><a href="../../../user/topics/tutorials/index.html">Tutorials</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/standalone_minion.html">Standalone Minion</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/cron.html">Using cron with Salt</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/states_pt1.html">States tutorial, part 1 - Basic Usage</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/states_pt2.html">States tutorial, part 2 - More Complex States, Requisites</a></li>
                              <li class=" no-child  active">
                                 <div id="toc"></div>
                              </li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/minionfs.html">MinionFS Backend Walkthrough</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/multimaster_pki.html">Multi-Master-PKI Tutorial With Failover</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/writing_tests.html">Writing Salt Tests</a></li>
                              <li class=" no-child "><a href="../../../user/topics/tutorials/halite.html">Installing and Configuring Halite</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/targeting/index.html">Targeting Minions</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/targeting/globbing.html">Matching the minion id</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/grains.html">Grains</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/ipcidr.html">Subnet/IP Address Matching</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/compound.html">Compound matchers</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/nodegroups.html">Node groups</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/batch.html">Batch Size</a></li>
                              <li class=" no-child "><a href="../../../user/topics/targeting/range.html">SECO Range</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/pillar/index.html">Storing Static Data in the Pillar</a></li>
                        <li class=" no-child "><a href="../../../user/topics/reactor/index.html">Reactor System</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/eauth/index.html">External Authentication System</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/eauth/access_control.html">Access Control System</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/event/index.html">Salt Event System</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/event/master_events.html">Salt Master Events</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/topology/syndic.html">Salt Syndic</a></li>
                        <li class=" no-child "><a href="../../../user/topics/topology/proxyminion/index.html">Proxy Minion</a></li>
                        <li class=" no-child "><a href="../../../user/topics/windows/windows-specific-behavior.html">Windows-specific Behaviour</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/cloud/index.html">Salt Cloud</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/cloud/basic.html">Salt Cloud basic usage</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/profiles.html">VM Profiles</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/map.html">Cloud Map File</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/action.html">Cloud Actions</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/function.html">Cloud Functions</a></li>
                              <li class=" collapsible  collapsed"><a href="../../../user/topics/cloud/provider-specifics.html">Cloud Provider Specifics</a><ul>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/parallels.html">Getting Started With Parallels</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/proxmox.html">Getting Started With Proxmox</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/lxc.html">Getting Started With LXC</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/hpcloud.html">Getting Started With HP Cloud</a></li>
                                    <li class=" no-child "><a href="../../../user/topics/cloud/vexxhost.html">Getting Started with VEXXHOST</a></li>
                                 </ul>
                              </li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/deploy.html">OS Support for Cloud VMs</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/features.html">Feature Matrix</a></li>
                              <li class=" no-child "><a href="../../../user/topics/cloud/windows.html">Spinning up Windows Minions</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/netapi/index.html">netapi modules</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/netapi/writing.html">Writing netapi modules</a></li>
                           </ul>
                        </li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/virt/index.html">Salt Virt</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/virt/disk.html">Virtual Machine Disk Profiles</a></li>
                              <li class=" no-child "><a href="../../../user/topics/virt/nic.html">Virtual Machine Network Profiles</a></li>
                           </ul>
                        </li>
                        <li class=" no-child "><a href="../../../user/topics/yaml/index.html">Understanding YAML</a></li>
                        <li class=" no-child "><a href="../../../user/topics/master_tops/index.html">Master Tops System</a></li>
                        <li class=" no-child "><a href="../../../user/topics/best_practices.html">Salt Best Practices</a></li>
                        <li class=" collapsible  collapsed"><a href="../../../user/topics/troubleshooting/index.html">Troubleshooting</a><ul>
                              <li class=" no-child "><a href="../../../user/topics/troubleshooting/minion.html">Troubleshooting the Salt Minion</a></li>
                           </ul>
                        </li>
                     </ul>
                  </li>
               </ul>
            </div>
         </div>
         <div id="page-content-wrapper">
            <div class="container-fluid">
               <div class="row">
                  <div class="col-lg-12">
                     <div class="page concept  - topic-topic concept-concept " id="states-tutorial-part-4">
                        
                        <h1 class="title topictitle1">States tutorial, part 4</h1>
                        <div class="body conbody">
                           <aside class="note "><span class="title">Note:</span> 
                              <p class="p">This tutorial builds on topics covered in <a class="xref" href="unresolvable-reference.html#__">part 1</a>,
                                 <a class="xref" href="unresolvable-reference.html#__">part 2</a> and <a class="xref" href="unresolvable-reference.html#__">part 3</a>. It is recommended
                                 that you begin there.
                              </p>
                              
                           </aside>
                           
                           <p class="p">This part of the tutorial will show how to use salt's <a class="xref" href="unresolvable-reference.html#configuring-the-salt-master__std:conf_master-file_roots">file_roots</a>
                              to set up a workflow in which states can be "promoted" from dev, to QA, to
                              production.
                           </p>
                           
                           <div class="section" id="states-tutorial-part-4__salt-fileserver-path-inheritance">
                              <h2 class="title sectiontitle">Salt fileserver path inheritance</h2>
                              <p class="p">Salt's fileserver allows for more than one root directory per environment, like
                                 in the below example, which uses both a local directory and a secondary
                                 location shared to the salt master via NFS:
                              </p>
                              <pre class="pre codeblock language-yaml"># In the master config file (/etc/salt/master)
file_roots:
  base:
    - /srv/salt
    - /mnt/salt-nfs/base</pre>
                              <p class="p">Salt's fileserver collapses the list of root directories into a single virtual
                                 environment containing all files from each root. If the same file exists at the
                                 same relative path in more than one root, then the top-most match "wins". For
                                 example, if <tt class="ph tt">/srv/salt/foo.txt</tt> and <tt class="ph tt">/mnt/salt-nfs/base/foo.txt</tt> both
                                 exist, then <tt class="ph tt">salt://foo.txt</tt> will point to <tt class="ph tt">/srv/salt/foo.txt</tt>.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="states-tutorial-part-4__environment-configuration">
                              <h2 class="title sectiontitle">Environment configuration</h2>
                              <p class="p">Configure a multiple-environment setup like so:</p>
                              <pre class="pre codeblock language-yaml">file_roots:
  base:
    - /srv/salt/prod
  qa:
    - /srv/salt/qa
    - /srv/salt/prod
  dev:
    - /srv/salt/dev
    - /srv/salt/qa
    - /srv/salt/prod</pre>
                              <p class="p">Given the path inheritance described above, files within <tt class="ph tt">/srv/salt/prod</tt>
                                 would be available in all environments. Files within <tt class="ph tt">/srv/salt/qa</tt> would be
                                 available in both <tt class="ph tt">qa</tt>, and <tt class="ph tt">dev</tt>. Finally, the files within
                                 <tt class="ph tt">/srv/salt/dev</tt> would only be available within the <tt class="ph tt">dev</tt> environment.
                              </p>
                              
                              <p class="p">Based on the order in which the roots are defined, new files/states can be
                                 placed within <tt class="ph tt">/srv/salt/dev</tt>, and pushed out to the dev hosts for testing.
                              </p>
                              
                              <p class="p">Those files/states can then be moved to the same relative path within
                                 <tt class="ph tt">/srv/salt/qa</tt>, and they are now available only in the <tt class="ph tt">dev</tt> and <tt class="ph tt">qa</tt>
                                 environments, allowing them to be pushed to QA hosts and tested.
                              </p>
                              
                              <p class="p">Finally, if moved to the same relative path within <tt class="ph tt">/srv/salt/prod</tt>, the
                                 files are now available in all three environments.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="states-tutorial-part-4__practical-example">
                              <h2 class="title sectiontitle">Practical Example</h2>
                              <p class="p">As an example, consider a simple website, installed to <tt class="ph tt">/var/www/foobarcom</tt>.
                                 Below is a top.sls that can be used to deploy the website:
                              </p>
                              
                              <p class="p"><tt class="ph tt">/srv/salt/prod/top.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">base:
  'web*prod*':
    - webserver.foobarcom
qa:
  'web*qa*':
    - webserver.foobarcom
dev:
  'web*dev*':
    - webserver.foobarcom</pre>
                              <p class="p">Using pillar, roles can be assigned to the hosts:</p>
                              
                              <p class="p"><tt class="ph tt">/srv/pillar/top.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">base:
  'web*prod*':
    - webserver.prod
  'web*qa*':
    - webserver.qa
  'web*dev*':
    - webserver.dev</pre>
                              <p class="p"><tt class="ph tt">/srv/pillar/webserver/prod.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">webserver_role: prod</pre>
                              <p class="p"><tt class="ph tt">/srv/pillar/webserver/qa.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">webserver_role: qa</pre>
                              <p class="p"><tt class="ph tt">/srv/pillar/webserver/dev.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">webserver_role: dev</pre>
                              <p class="p">And finally, the SLS to deploy the website:</p>
                              
                              <p class="p"><tt class="ph tt">/srv/salt/prod/webserver/foobarcom.sls:</tt></p>
                              <pre class="pre codeblock language-yaml">{% if pillar.get('webserver_role', '') %}
/var/www/foobarcom:
  file.recurse:
    - source: salt://webserver/src/foobarcom
    - env: {{ pillar['webserver_role'] }}
    - user: www
    - group: www
    - dir_mode: 755
    - file_mode: 644
{% endif %}</pre>
                              <p class="p">Given the above SLS, the source for the website should initially be placed in
                                 <tt class="ph tt">/srv/salt/dev/webserver/src/foobarcom</tt>.
                              </p>
                              
                              <p class="p">First, let's deploy to dev. Given the configuration in the top file, this can
                                 be done using <a class="xref" href="unresolvable-reference.html#module-salt.modules.state__salt.modules.state.highstate">state.highstate</a>:
                              </p>
                              <pre class="pre codeblock language-bash">salt --pillar 'webserver_role:dev' state.highstate</pre>
                              <p class="p">However, in the event that it is not desirable to apply all states configured
                                 in the top file (which could be likely in more complex setups), it is possible
                                 to apply just the states for the <tt class="ph tt">foobarcom</tt> website, using <a class="xref" href="unresolvable-reference.html#module-salt.modules.state__salt.modules.state.sls">state.sls</a>:
                              </p>
                              <pre class="pre codeblock language-bash">salt --pillar 'webserver_role:dev' state.sls webserver.foobarcom</pre>
                              <p class="p">Once the site has been tested in dev, then the files can be moved from
                                 <tt class="ph tt">/srv/salt/dev/webserver/src/foobarcom</tt> to
                                 <tt class="ph tt">/srv/salt/qa/webserver/src/foobarcom</tt>, and deployed using the following:
                              </p>
                              <pre class="pre codeblock language-bash">salt --pillar 'webserver_role:qa' state.sls webserver.foobarcom</pre>
                              <p class="p">Finally, once the site has been tested in qa, then the files can be moved from
                                 <tt class="ph tt">/srv/salt/qa/webserver/src/foobarcom</tt> to
                                 <tt class="ph tt">/srv/salt/prod/webserver/src/foobarcom</tt>, and deployed using the following:
                              </p>
                              <pre class="pre codeblock language-bash">salt --pillar 'webserver_role:prod' state.sls webserver.foobarcom</pre>
                              <p class="p">Thanks to Salt's fileserver inheritance, even though the files have been moved
                                 to within <tt class="ph tt">/srv/salt/prod</tt>, they are still available from the same
                                 <tt class="ph tt">salt://</tt> URI in both the qa and dev environments.
                              </p>
                              
                           </div>
                           
                           <div class="section" id="states-tutorial-part-4__continue-learning">
                              <h2 class="title sectiontitle">Continue Learning</h2>
                              <p class="p">The best way to continue learning about Salt States is to read through the
                                 <a class="xref" href="unresolvable-reference.html#__">reference documentation</a> and to look through examples
                                 of existing state trees. Many pre-configured state trees
                                 can be found on Github in the <a class="xref" href="https://github.com/saltstack-formulas" target="_blank">saltstack-formulas</a> collection of repositories.
                              </p>
                              
                              <p class="p">If you have any questions, suggestions, or just want to chat with other people
                                 who are using Salt, we have a very <a class="xref" href="unresolvable-reference.html#introduction-to-salt__salt-community">active community</a>
                                 and we'd love to hear from you.
                              </p>
                              
                              <p class="p">In addition, by continuing to <a class="xref" href="unresolvable-reference.html#__">part 5</a>, you can learn about
                                 the powerful orchestration of which Salt is capable.
                              </p>
                              
                           </div>
                           
                        </div>
                        
                        <div xmlns:htmlutil="http://dita4publishers.org/functions/htmlutil" class="related-links"></div>
                     </div>
                     <button id="next-button" type="button" class="btn btn-primary">
                        Next <span class="glyphicon glyphicon-chevron-right"></span></button><div class="footer">
                        <p class="text-muted pull-right"><small>Copyright Â© 2015 SaltStack.</small></p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </body>
</html>